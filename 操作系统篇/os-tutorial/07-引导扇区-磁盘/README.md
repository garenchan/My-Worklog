# 引导扇区-磁盘


## 概念

硬盘、柱面、磁头、扇区、进位


## 目标

**让引导扇区从磁盘加载数据以引导内核**

我们的OS不适合放在引导扇区的512字节中，所以我们需要从磁盘读取数据来运行内核。

幸运的是，我们不需要处理旋转磁盘的开关，我们可以调用一些BIOS例程，就像我们在屏幕
上打印字符一样。为此，我们将`al`设置为`0x02`(以及其他具有所需的柱面、磁头和扇区
的寄存器)，然后引发`int 0x13`。

你可以在这里访问[详细的int 13h指南](http://stanislavs.org/helppc/int_13-2.html)。

在这节课上，我们将首次使用进位，它是出现在每个寄存器中一个额外的位，当一个操作超
过其当前容量时存储:

```nasm
mov ax, 0xFFFF
add ax, 1 ; ax = 0x0000 and carry = 1
```

进位不是直接访问的，而是被其他操作符用作控制结构，比如`jc`(如果进位则跳转)。

BIOS还将`al`设置为所读扇区的数量，因此总是将其与预期数量进行比较。


## 代码

打开并检查`boot_sect_disk.asm`中用于从磁盘读取的完整例程。

`boot_sect_main.asm`为磁盘读取准备参数，并调用`disk_load`。注意我们如何写入一些实
际上不属于引导扇区的额外数据，因此它位于512位标记之外。

引导扇区实际上是磁盘驱动器0的磁头0的柱面0的扇区1(第一个，扇区从1开始)。

因此，512字节后的任何字节(实际上只能是512个字节)都对应于磁盘驱动器0的磁头0的柱面
0的扇区2。

主例程将用示例数据填充它，然后让引导扇区读取它。

**注意：如果你一直收到错误，并且你的代码看起来没问题，那么请确保qemu从正确的驱动器
引导，并相应地在`dl`上设置驱动器。**

BIOS在调用引导加载程序之前将`dl`设置为驱动器号。然而，在从硬盘驱动器引导时，我发
现qemu存在一些问题。

有两个快速的选择：

1. 尝试使用标志`-fda`，例如`qemu -fda boot_sect_main.bin`，这会将`dl`设置为`0x00`，
然后似乎能正常工作。
2. 显式地使用标志`-boot`，例如`qemu boot_sect_main.bin -boot c`，这会自动将`dl`
设置为`0x80`并让引导加载程序读取数据。
