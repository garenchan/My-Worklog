# OpenStack整合Hyper-V

* 目前我使用的是OpenStack Mitaka版本, 虚拟网络使用的Neutron VXLAN模式, 所以以下会主要针对这些版本进行描述

* 前一节有学习在Windows Server 2016上部署Hyper-V, 现在我们需要把这台服务器当做计算节点加入OpenStack中, 也就意味这你需要先部署好控制节点和网络节点


## 部署Hyper-V计算节点

由于OpenStack Nova组件的各个服务有调用到一些Posix上相关的接口或工具, 因此在Windows上是无法正常运行的;

不过有家公司Cloudbase提供了开源的针对Hyper-V的Nova组件, 我们下载它提供的安装包进行安装即可.

### 下载Hyper-V的Nova Compute安装包

[Hyper-V Nova Compute Installer下载地址](https://cloudbase.it/openstack-hyperv-driver/)

注: 由于Cloudbase只会提供版本较新的安装包, 如果你找不到合适你的安装包版本, 不妨从安装包文件的链接地址入手

    Newton[14.0.1]: https://cloudbase.it/downloads/HyperVNovaCompute_Newton_14_0_1.msi
    Ocata[15.0.0]: https://cloudbase.it/downloads/HyperVNovaCompute_Ocata_15_0_0.msi
    Pike[16.0.0]: https://cloudbase.it/downloads/HyperVNovaCompute_Pike_16_0_0_1.msi

通过已知的这些链接地址, 我们发现是有规律可循的, 我通过测试发现我要找的Mitaka版本安装包的链接地址为:

**https://cloudbase.it/downloads/HyperVNovaCompute_Mitaka_13_0_0.msi**

### 安装Nova Compute

* 双击安装包进行安装, 如果你尚未部署Hyper-V, 那么会提示你: "Please enable Hyper-V before installing this software".

* 安装过程十分简单, 可参考[Hyper-V Nova Compute安装说明](https://cloudbase.it/installing-openstack-nova-compute-on-hyper-v/).

* 如果你使用的Nuetron VLAN或者Flat模式, 那么到这里整个安装过程就宣告结束了, 意味着你可以通过Horizon或命令行来创建Hyper-V虚拟机了.

* 如果你使用的Nuetron VXLAN或者GRE模式, 那么还需要往下看, 原因如下:

    Nova Compute安装包实际上也会安装一个Neutron Hyper-V Agent, 顾名思义就是Neutron在Hyper-V节点上的代理, 而这个代理当前版本是不支持VXLAN或者GRE模式的, 只支持LOCAL/FLAT/VLAN模式


## 部署Open vSwitch

在Windows上部署Open vSwitch, 实际是给HyperV虚拟交换机增加了一个流量转发扩展, 使得HyperV虚拟交换机可以支持GENEVE、GRE、VXLAN和STT

### 下载Open vSwitch For Windows

[Open vSwitch For Windows下载地址](https://cloudbase.it/downloads/openvswitch-hyperv-2.7.0-certified.msi)

注: 如果要安装最新版本的Open vSwitch For Windows, 请前往[Open vSwitch最新版本](https://cloudbase.it/openvswitch/#download)

### 安装Open vSwitch

安装过程是傻瓜式的, 如果希望使用静默安装, 请使用如下命令:
```
msiexec /i openvswitch-hyperv.msi /l*v log.txt
```

### 配置Open vSwitch

假设我们有多个网卡, 其中有一个网卡用来做VXLAN或者GRE模式的内部网络网卡, 也即作为隧道端点, 那么该网卡需要有一个该IP可以与其他节点的隧道端点进行通信, 现在我们不要把这个IP直接分配在该网卡上而是留作它用

* 以管理员权限打开PowerShell(在CMD或在"运行"输入PowerShell均可)

* 获取当前服务器的网络适配器:
```
PS C:\package> Get-NetAdapter

Name      InterfaceDescription                    ifIndex  Status       MacAddress             LinkSpeed
----      --------------------                    -------  ------       ----------             ---------
port3     Intel(R) 82574L Gigabit Network Co...#3      26  Up           00-0C-29-40-8B-EA         1 Gbps
nat       Intel(R) 82574L Gigabit Network Co...#4      27  Up           00-0C-29-40-8B-E0         1 Gbps
port2     Intel(R) 82574L Gigabit Network Co...#2      18  Up           00-0C-29-40-8B-D6         1 Gbps
port1     Intel(R) 82574L Gigabit Network Conn...      17  Up           00-0C-29-40-8B-CC         1 Gbps
```

* 假设port1是我们拿来做内部网络的网卡, 那么我们需要在其上创建一个HyperV外部虚拟交换机, 虚拟交换机名称举例为vSwitch:

```
PS C:\package> New-VMSwitch -Name vSwitch -NetAdapterName port1 -AllowManagementOS $false
 
Name    SwitchType NetAdapterInterfaceDescription
----    ---------- ------------------------------
vSwitch External   Intel(R) 82574L Gigabit Network Connection
```

* 验证流量转发扩展是否安装成功(或者说Open vSwitch是否安装成功), 如果有如下所示的输出, 那么即表明安装成功:
```
PS C:\package> Get-VMSwitchExtension -VMSwitchName vSwitch -Name "Cloudbase Open vSwitch Extension"
 
Id                  : 583CC151-73EC-4A6A-8B47-578297AD7623
Name                : Cloudbase Open vSwitch Extension
Vendor              : Cloudbase Solutions SRL
Version             : 13.43.16.16
ExtensionType       : Forwarding
ParentExtensionId   :
ParentExtensionName :
SwitchId            : 5844f4dd-b3d7-496c-81cb-481a64fa7f58
SwitchName          : vSwitch
Enabled             : False
Running             : False
ComputerName        : HYPERV_NORMAL_1
Key                 :
IsDeleted           : False
```

* 如上所示, 该扩展默认情况下是被禁用掉的, 我们现在需要开启它:
```
PS C:\package> Enable-VMSwitchExtension -VMSwitchName vSwitch -Name "Cloudbase Open vSwitch Extension"
 
Id                  : 583CC151-73EC-4A6A-8B47-578297AD7623
Name                : Cloudbase Open vSwitch Extension
Vendor              : Cloudbase Solutions SRL
Version             : 13.43.16.16
ExtensionType       : Forwarding
ParentExtensionId   :
ParentExtensionName :
SwitchId            : 5844f4dd-b3d7-496c-81cb-481a64fa7f58
SwitchName          : vSwitch
Enabled             : True
Running             : True
ComputerName        : HYPERV_NORMAL_1
Key                 :
IsDeleted           : False
```

* 注意, 如果开启该扩展后上述创建的虚拟交换机会停止转发流量直至我们将port1网卡连接到一个OpenvSwitch网桥为止:

首先, 创建一个OpenvSwitch网桥, 我们可以在网络适配器中看到它:
```
PS C:\package> ovs-vsctl.exe add-br br-port1
PS C:\package> Get-NetAdapter
 
Name       InterfaceDescription                    ifIndex Status       MacAddress             LinkSpeed
----       --------------------                    ------- ------       ----------             ---------
br-port1   Hyper-V Virtual Ethernet Adapter #2          47 Disabled     00-15-5D-00-62-79        10 Gbps
port3      Intel(R) 82574L Gigabit Network Co...#3      26 Up           00-0C-29-40-8B-EA         1 Gbps
nat        Intel(R) 82574L Gigabit Network Co...#4      27 Up           00-0C-29-40-8B-E0         1 Gbps
port2      Intel(R) 82574L Gigabit Network Co...#2      18 Up           00-0C-29-40-8B-D6         1 Gbps
port1      Intel(R) 82574L Gigabit Network Conn...      17 Up           00-0C-29-40-8B-CC         1 Gbps
```
然后, 由于默认情况下它是被禁用的, 现在需要开启它, 并将之前留作它用的IP分配给它, 这里IP举例为14.14.14.2, 接来下我们可以使用14.14.14.2来访问该服务器了, 可以验证一下:
```
PS C:\package> Enable-NetAdapter br-port1
PS C:\package> New-NetIPAddress -IPAddress 14.14.14.2 -InterfaceAlias br-port1 -PrefixLength 24
 
IPAddress         : 14.14.14.2
InterfaceIndex    : 47
InterfaceAlias    : br-port1
AddressFamily     : IPv4
Type              : Unicast
PrefixLength      : 24
PrefixOrigin      : Manual
SuffixOrigin      : Manual
AddressState      : Tentative
ValidLifetime     : Infinite ([TimeSpan]::MaxValue)
PreferredLifetime : Infinite ([TimeSpan]::MaxValue)
SkipAsSource      : False
PolicyStore       : ActiveStore
 
IPAddress         : 14.14.14.2
InterfaceIndex    : 47
InterfaceAlias    : br-port1
AddressFamily     : IPv4
Type              : Unicast
PrefixLength      : 24
PrefixOrigin      : Manual
SuffixOrigin      : Manual
AddressState      : Invalid
ValidLifetime     : Infinite ([TimeSpan]::MaxValue)
PreferredLifetime : Infinite ([TimeSpan]::MaxValue)
SkipAsSource      : False
PolicyStore       : PersistentStore
```
最后, 使port1网卡连接到该OpenvSwitch网桥上:
```
PS C:\package> ovs-vsctl.exe add-port br-port1 port1
```

## 部署Neutron