# Neutron配置文档


## ML2 Plug-in

### 架构

作为一个框架，允许OpenStack网络支持现实世界各种数据中心中使用的各种复杂的2层网络技术，区分出了2类可配置的驱动：

    1. Type drivers
    定义如何在技术上实现OpenStack网络，例如vxlan
    2. Mechanism drivers
    定义访问特定类型OpenStack网络的机制，例如OpenVSwitch mechanism driver

### 配置

#### 网络类型驱动

全部可用的网络类型驱动:

* Flat
* VLAN
* GRE
* VXLAN

供应商网络类型：

* Flat
* VLAN
* GRE
* VXLAN

项目网络类型：

* VLAN
* GRE
* VXLAN

#### 机制驱动

* Linux Bridge
* Open vSwitch
* SRIOV
* MacVTap
* L2 population
* Specialized， 譬如OpenDaylight

#### 扩展驱动

* QoS (当前未使用)
* port security (当前已使用)
* dns

#### 代理

##### L2 agent

L2 agent为OpenStack资源提供2层网络的连通性，运行在网络节点和计算节点上

* Open vSwitch agent (当前正在使用中的)
* Linux Bridge agent
* SRIOV Nic Switch agent
* MacVTap agent

##### L3 agent

L3 agent提供高级的3层服务，例如虚拟路由和浮动IP；需要和L2 agent同时运行

##### DHCP agent

DHCP agent负责管理DHCP和RADVD服务，它需要在同一个节点上运行L2 agent

##### Metadata agent

Metadata agent允许实例通过网络检索cloud-init元数据和用户数据，它需要在同一个节点上运行L2 agent

##### L3 metering agent

公有云厂商提供按流量计费的功能需要借助这个来实现？

#### 安全

L2 agent支持一些重要的安全配置：

* security group
* arp欺骗防护


## Address scopes

使用address scope后可以使外部网络和内部网络直接通信而不需要经过NAT


## Automatic allocation of network topologies

在创建虚拟机实例前，需要经过如下几步：

    1. Create a network
    2. Create a subnet
    3. Create a router
    4. Uplink the router on an external network
    5. Downlink the router on the previously created subnet

通过auto-allocated-topology扩展，我们可以省略以上几步来创建虚拟机实例，其实这个扩展就是帮我们自动创建一个网络(含子网)、一个路由器(连接到默认的外部网络上)


## Availability zones

network和router都有可用域
l3_ha = true 开启l3高可用


## BGP dynamic routing

pass


## High-availability for DHCP

配置/etc/neutron/neutron.conf， 开启dhcp ha
dhcp_agents_per_network = 3
在其他计算节点上安装neutron-dhcp-agent，然后进行适当配置即可
每增加一个neutron-dhcp-agent，都会在其管理的子网上增加一个dhcp port


## DNS integration

### 内部DNS解析

1. 配置/etc/neutron/plugins/ml2/ml2_conf.ini:
```
[ml2]
Extension_drivers = port_security,dns
```

2. 配置/etc/neutron/neutron.conf:
```
[DEFAULT]
dns_domain = example.org.
```

3. 重启neutron-server，就可以在port上面设置dns_name属性了，如果使用默认的dns_domain值可能出现设置dns_name不生效的情况，另外可能需要killall dnsmasq重启dhcp agent来清空之前的dns记录

**同一子网内的虚拟机实例可以通过这些内部域名进行通信，由dnsmasq负责解析**

### 整合外部DNS服务

pass


## Name resolution for instances

场景1：每个虚拟子网都使用单独的DNS解析器(会覆盖2的配置)

    我们在创建子网时可以指定多个DNS名称服务器

场景2：全部虚拟网络使用相同的DNS解析器

    配置/etc/neutron/dhcp_agent.ini，重启dhcp agent
```
[DEFAULT]
dnsmasq_dns_servers = 8.8.8.8, 8.8.4.4
```

场景3：全部虚拟网络使用DHCP agent所在主机配置的DNS解析器:

    配置/etc/neutron/dhcp_agent.ini，重启dhcp agent
```
[DEFAULT]
dnsmasq_local_resolv = True
```


## Distributed Virtual Routing with VRRP

基于VRRP(虚拟路由冗余协议)的分布式虚拟路由

使用DVR来实现HA的Open vSwitch支持使用VRRP来进行增强

master router定期发送heartbeat；当后备router在一段时间收不到heartbeat后，它就假设master router出问题了，然后在snat网络命名空间中的接口上配置IP地址，将自己提升为master router；在有多个后备router的情况下，根据VRRP规则选举出新的master router

### 配置示例

#### 控制节点配置

1.编辑/etc/neutron/neutron.conf，那么创建的router默认就是DVR和HA的：
```
[DEFAULT]
router_distributed = True
l3_ha = True
l3_ha_net_cidr = 169.254.192.0/18
max_l3_agents_per_router = 3
min_l3_agents_per_router = 2
```

#### 网络节点配置

1.编辑/etc/neutron/plugins/ml2/ml2_conf.ini：
```
[agent]
enable_distributed_routing = True
```

2.编辑/etc/neutron/l3_agent.ini：
```
[DEFAULT]
ha_vrrp_auth_password = password
agent_mode = dvr_snat
```

#### 计算节点配置

1.编辑/etc/neutron/plugins/ml2/ml2_conf.ini：
```
[agent]
enable_distributed_routing = True
```

2.编辑/etc/neutron/l3_agent.ini：
```
[DEFAULT]
agent_mode = dvr
```

### 已知限制

1.不能从仅为DVR、仅为HA或过时的router迁移为DVR且HA的，反向也不可以

2.在某些情况下，l2pop和DVR HR router不会以预期的方式进行交互，这个情况在仅为HA的router和l2pop下同样存在


## IPAM configuration

用于支持IP地址管理的驱动框架，支持与可选的IPAM实现或第三方管理系统的集成

### 基本配置

编辑/etc/neutron/neutron.conf来配置IPAM驱动:
```
[DEFAULT]
Ipam_driver = ipam-driver-name
```

### 已知限制

1.驱动程序接口被设计成支持为不同的subnet pool指定不同的驱动，然而目前的实现只支持在系统范围内指定一个IPAM驱动

2.第三方驱动程序必须提供自己的迁移机制来将现有的OpenStack安装转换为它的IPAM
