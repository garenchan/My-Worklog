# 3种MPM模式

Unix下Apache的MPM(Multi-Processing Module, 多处理模块)支持3种模式: prefork、worker和event


## 模式优劣

### prefork

预先派生一些子进程(进程池?), 等待和处理请求; 减少频繁创建和销毁进程带来的额外开销; 每个子进程只有一个线程, 因此只能同时处理一个请求.

优点: 成熟稳定, 兼容各种新老模块; 不用担心线程安全问题

缺点: 进程会占用较多的系统资源, 不善于处理高并发场景.

### worker

使用了多进程和多线程的混合模式, 也是预先派生一些子进程(数量较少), 然后每个子进程创建一些线程, 包括一个监听线程和多个服务线程

优点: 线程相对于进程会更轻量级一些, 因此占用的系统资源会少一点; 一个线程出现了异常可能导致同一进程的其他线程也出现问题(共享地址空间), 为了稳定性, 因此也需要引入多进程(与Nginx类似); 高并发下表现更优秀

缺点: 需要考虑线程安全问题

### event

基于worker模式, 为了解决keep-alive请求导致的问题而引入, 即使连接是空闲的, 服务线程也会一直被占用, 严重时导致无服务线程可用; 以上2种模式都存在这个问题

在该模式下, 会有一个专门的线程来hold住这些keep-alive类型的长连接, 只有当真实请求到来的时候, 才将请求传递给服务线程, 处理完毕后, 服务线程可"释放"连接

注: event需要借助I/O多路复用模型譬如select、poll和epoll


## 查看当前模式

```
apachectl -V | grep -i mpm
```


## 总结

1. 追求可靠性和旧软件兼容性的站点可以使用prefork模式

2. 追求高并发和高伸缩性的站点可以选择使用worker模式或event模式
